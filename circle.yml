machine:
  environment:
    GRADLE_OPTS: '-Dorg.gradle.jvmargs="-Xmx1024m -XX:+HeapDumpOnOutOfMemoryError"'
    XCODE_SCHEME: browse.goodcity
    XCODE_WORKSPACE: browse.goodcity
    GYM_CODE_SIGNING_IDENTITY: "iPhone Distribution: Crossroads Foundation Limited"

dependencies:
  pre:
    - brew update
    - brew install homebrew/versions/node4-lts
    - brew install watchman
    - brew install android-sdk
    - echo 'export ANDROID_HOME=/usr/local/opt/android-sdk' >> ~/.circlerc
    - ( sleep 5 && while [ 1 ]; do sleep 1; echo y; done ) | android update sdk --no-ui --all --filter platform-tools,build-tools-23.0.3,android-23,extra-android-m2repository,extra-google-m2repository
    - echo 'export PATH=$ANDROID_HOME/build-tools/23.0.3:$PATH' >> ~/.circlerc
    - npm rebuild node-sass
    - npm install bower ember-cli phantomjs-prebuilt cordova
    - gem update fastlane
  post:
    - ./node_modules/bower/bin/bower install
    # - |
    #   if [ "${CIRCLE_BRANCH}" = 'live' ] ; then
    #     echo 'export PROVISIONING_FILE=browse.goodcity.hk.mobileprovision' >> ~/.circlerc
    #   else
    #     echo 'export PROVISIONING_FILE=browse-staging.goodcity.hk.mobileprovision' >> ~/.circlerc
    #   fi

test:
  pre:
    # - ./node_modules/ember-cli/bin/ember server:
        # background: true
    - sleep 5
  override:
    # - ./node_modules/ember-cli/bin/ember test
    - echo "No testing"
  post:
    - echo "Killing ember server to free memory for app build" && killall ember

deployment:
  staging:
    branch: master
    commands:
      - PATH=$(npm bin):$PATH; azure-filestore download -f browse-staging.goodcity.hk.mobileprovision:
          pwd: scripts
      - ./install-provisioning-file.sh:
          pwd: scripts
      - bundle exec cap staging deploy
      - PATH=$(npm bin):$PATH; azure-filestore download -f goodcity.keystore:
          pwd: cordova
      - bundle exec rake staging android app:release
      - bundle exec rake staging ios app:release
  ci-mobile-provision:
    branch: ci-mobile-provision
    commands:
      - bundle exec rake staging ios app:build
      - ipa distribute:testfairy
          --key     "$TESTFAIRY_API_KEY"
          --comment "CircleCI build $CIRCLE_BUILD_URL"
    
  production:
    branch: live
    commands:
      - PATH=$(npm bin):$PATH; azure-filestore download -f browse.goodcity.hk.mobileprovision:
          pwd: scripts
      - ./install-provisioning-file.sh:
          pwd: scripts
      - PATH=$(npm bin):$PATH; azure-filestore download -f goodcity.keystore:
          pwd: cordova
      - PATH=$(npm bin):$PATH; azure-filestore download -d google-play -f $GOOGLE_PLAY_KEY_FILE:
          pwd: fastlane
      - bundle exec cap production deploy
      - bundle exec rake production android app:release
      - bundle exec rake production ios app:release
      - fastlane android beta
      - fastlane ios upload
      - fastlane ios beta
